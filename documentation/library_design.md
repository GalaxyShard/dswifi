# Library design

DSWifi is a library that runs on the ARM9 and ARM7 simultaneously, and it has a
fundamentally asynchronous design. The ARM9 sends commands to the ARM7 using
shared RAM, and the ARM7 eventually handles the commands. This design is
consistent with how WiFi works: some actions require a long time to complete,
sometimes up to a few seconds!

The ARM7 can do several operations without intervention from the ARM9. It can
look for access points and connect to them. It can act as an access point (when
acting as a multiplayer host) and accept and deny connections. This means that,
in practice, the ARM9 sets the desired state of the ARM7 and the ARM7 performs
steps in the direction that will reach the desired state of the ARM9.

## 1. Library modes

The library supports three global modes:

- Internet mode.
- Local multiplayer host.
- Local multiplayer client.

It also supports other internal modes:

- **Disabled**: The WiFi hardware is powered off.
- **Normal/Idle**: The WiFi hardware is powered on, but not doing anything. This
  is the only mode in which the library can switch between the three global
  modes. If a library mode change is requested, it will first go to normal mode.
- **Scan**: DSWifi is iterating through all channels looking for access points.
  In Internet mode it lists all available APs. In local multiplayer client mode
  it only lists APs with Nintendo metadata. Note that the list of APs is cleared
  whenever scan mode is entered.
- **Associate**: DSWifi is trying to connect to an AP (either in Internet mode
  or in local multiplayer mode).
- **Associated**: DSWifi has managed to connect to the AP.
- **Can't associate**: DSWifi has failed to connect to the AP. The library must
  return to normal mode before attempting another connection.
- **Access point**: The DS is acting as an access point. This mode can only be
  used when DSWifi is acting as a local multiplayer host.

## 2. Transmitting and receiving packets

As an initial explanation: DSWifi has three queues in regular RAM, and two in
WiFi MAC RAM.

Both the ARM9 and ARM7 can transmit packets. The ARM7 sends management packets
and manages the responses. For example, this is done to connect to APs, and to
let other DS devices connect to a DS acting as host. If the ARM9 had to handle
the connection handshake it would be much less efficient.

## 2.1 TX packets

When transmitting packets generated by the ARM7, they are saved to a temporary
buffer (at the moment, this buffer can only hold one packet).

When transmitting packets from the ARM9 they are saved in a circular buffer in
shared memory between the ARM7 and ARM9. Then, the ARM9 sends a sync FIFO
message to the ARM7 to notify it that there are packets in that buffer.

The ARM7 has priority transmitting packets over the ARM9. If there is any packet
in the ARM7 queue, that one will be transmitted over the ones waiting to be
transmitted from the ARM9.

Regardless of the origin, in the end, the packet is copied to MAC RAM, and the
transfer is started. After the transmission is complete, an interrupt is
generated, and the ARM7 checks the queues again. Only one packet is ever copied
to MAC RAM at any point.

## 2.2 RX packets

When receiving packets, they are saved by the hardware in MAC RAM in a circular
buffer. When packets are received, an interrupt is triggered, and the ARM7
starts handling them.

Some packets are handled directly by the ARM7 and they are never sent to the
ARM9 (authentication and beacon packets, for example). Data packets are saved to
a circular buffer in shared RAM between ARM7 and ARM9. Whenever a packet is
saved to this buffer, the ARM7 sends a sync FIFO message to the ARM9 to notify
it. Eventually, the ARM9 will check the buffer and handle it.

When in Internet mode, data packets are sent to sgIP. When in multiplayer mode,
data packets are sent to the packet handlers defined by the developer.

### 2.3 Beacon packets

When in multiplayer host mode, it is required to regularly send beacon packets.
This packet is generated on the ARM9 and sent to the ARM7 using the regular TX
queues, but it isn't sent by the ARM7 as usual. It is saved in a specific part
of MAC RAM reserved for beacon packets. The hardware regularly sends this packet
without any kind of DSWifi intervention.

### 2.4 Multiplayer packets

CMD packets are handled like regular ARM9 packets, only the hardware
transmission step is different.

REPLY packets are different. There are two memory regions in MAC RAM reserved
for REPLY packets. They are independent from the TX buffer region, so a
multiplayer client can still send regular messages while a REPLY packet is ready
to be sent.

Multiplayer packets are handled like regular data packets when they are
received. They are sent to the ARM9 using the same queue as regular data
packets.

## 3. Debug messages of DSWifi

Work in progress.

## 4. Connecting to APs

Work in progress.

## 5. Multiplayer mode design

Work in progress.
